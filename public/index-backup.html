<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Battery Rental Status</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jersey+10&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 10px 20px;
            background-color: #000000;
            color: #FFFFFF;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            box-sizing: border-box;
            margin: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px 15px;
            }
        }

        #output {
            margin: 0px;
        }

        .view-locations-btn {
            display: block;
            width: calc(100% - 20px);
            margin: 8px 10px;
            padding: 20px;
            font-size: 16px;
            color: white;
            background-color: #0099FF;
            border: 1px solid #3789BC;
            border-radius: 20px;
            cursor: pointer;
            text-align: left;
            height: auto;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .view-locations-btn {
                width: calc(100% - 10px);
                margin: 8px 5px;
                padding: 18px 16px;
            }
        }

        .view-locations-btn:hover {
            background-color: #007ACC;
        }

        #batteryIdDisplay {
            font-weight: bold;
            margin-top: 30px;
            font-weight: bold;
            font-size: 30px;
            color: #1F1F1F;
        }

        #elapsedTime {
            margin: 0px;
            font-size: 25px;
            font-weight: bold;
            color: #FFFFFF;
            padding: 0px;
            border-radius: 5px;
            display: inline-block;
        }

        #amountPaid {
            margin-top: 10px;
            margin-bottom: -10px;
            margin-left: 0px;
            margin-right: 0px;
            font-size: 50px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-style: normal;
            color: #FFFFFF;
            padding: 0px;
            border-radius: 20px;
            display: inline-block;
        }

        .containers-wrapper {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 0 10px;
        }

        @media (max-width: 768px) {
            .containers-wrapper {
                margin: 0 5px;
                gap: 6px;
            }
        }

        #amountPaidContainer {
            background-color: #000000;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #35383C;
            text-align: left;
            flex: 1;
            box-sizing: border-box;
            height: auto;
        }

        #newContainer {
            background-color: #1C1E20;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #35383C;
            text-align: left;
            flex: 1;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-sizing: border-box;
            position: relative;
        }


        #newContainer > div {
            position: relative;
            z-index: 2;
        }

        #newContainer:hover {
            background-color: #2A2C2E;
        }

        #newContainerValue {
            margin-top: -10px;
            margin-bottom: -10px;
            margin-left: 0px;
            margin-right: 0px;
            font-size: 75px;
            font-family: "Jersey 10", serif;
            font-weight: 400;
            font-style: normal;
            color: #FFFFFF;
            padding: 0px;
            border-radius: 20px;
            display: inline-block;
        }

        #elapsedTimeContainer {
            Margin-top: 40px;
            Margin-bottom: 40px;
            text-align: Center;
        }


        .support-btn {
            display: block;
            width: calc(100% - 20px);
            color: white;
            background-color: #1C1E20;
            border: 1px solid #35383C;
            border-radius: 20px;
            cursor: pointer;
            text-align: left;
            padding: 20px;
            margin: 8px 10px 0;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .support-btn {
                width: calc(100% - 10px);
                margin: 8px 5px 0;
                padding: 18px 16px;
            }
        }

        .support-btn:hover {
            background-color: #262626;
        }

        .typing-animation {
            border-right: 2px solid #B0D2FF;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { border-color: transparent; }
            51%, 100% { border-color: #B0D2FF; }
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        .typewriter-text {
            overflow: hidden;
            white-space: nowrap;
            width: 0;
            animation: typewriter 3s steps(40, end) forwards;
        }

        /* Map Styles */
        #mapContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #000000;
            z-index: 10000;
            display: none;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10001;
            background-color: #000000;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .back-button:hover {
            background-color: #333333;
        }

        .mapboxgl-popup-content {
            background-color: #1F1F1F;
            color: #FFFFFF;
            border-radius: 8px;
        }

        .mapboxgl-popup-tip {
            border-top-color: #1F1F1F;
        }

        .station-info {
            padding: 5px;
        }

        .station-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .station-address {
            font-size: 14px;
            color: #CCCCCC;
        }

        .bottom-popup {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background-color: #000000;
            color: #FFFFFF;
            padding: 20px;
            border-radius: 20px;
            border: 2px solid #333333;
            z-index: 10002;
            transform: translateY(calc(100% + 50px));
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }

        .bottom-popup.show {
            transform: translateY(0);
        }

        .popup-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
        }

        .popup-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
        }

        .popup-left {
            flex: 1;
            display: flex;
            align-items: stretch;
        }

        .popup-right {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            align-items: stretch;
        }

        .popup-title {
            font-size: 18px;
            font-weight: bold;
            color: #FFFFFF;
            text-align: left;
        }

        .close-btn {
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #CCCCCC;
        }

        .availability-info-new {
            display: flex;
            justify-content: space-between;
            text-align: center;
            gap: 40px;
        }

        .availability-item-new {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .availability-icon-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .availability-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .blue-dot {
            background-color: #009FFF;
        }

        .gray-dot {
            background-color: #808080;
        }

        .availability-number-new {
            font-size: 18px;
            font-weight: bold;
            color: #FFFFFF;
        }

        .availability-label-new {
            font-size: 14px;
            color: #CCCCCC;
            font-weight: normal;
            white-space: nowrap;
        }

        .availability-info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
        }

        .availability-item {
            flex: 1;
        }

        .availability-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .available {
            color: #4CAF50;
        }

        .occupied {
            color: #FF6B6B;
        }

        .availability-label {
            font-size: 14px;
            color: #CCCCCC;
        }

        .directions-btn {
            width: 100%;
            background-color: #009FFF;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .directions-btn:hover {
            background-color: #007ACC;
        }

        .station-address-popup {
            font-size: 14px;
            color: #CCCCCC;
            margin-bottom: 10px;
        }

        .rental-status-window {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 1.0);
            color: #FFFFFF;
            padding: 15px;
            border-radius: 20px;
            z-index: 10003;
            min-width: 200px;
            border: 1px solid #333333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .status-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            font-size: 14px;
            color: #CCCCCC;
            font-weight: normal;
        }

        .status-value {
            font-size: 16px;
            color: #FFFFFF;
            font-weight: bold;
        }

        #statusAmount {
            color: #FFFFFF;
        }
    </style>
</head>
<body>
<!-- Rental Status Window -->
<div id="rentalStatus" class="rental-status-window" style="display: none;">
    <div class="status-content">
        <div class="status-row">
            <span class="status-label">Duration:</span>
            <span id="statusDuration" class="status-value">--:--:--</span>
        </div>
        <div class="status-row">
            <span class="status-label">Paid:</span>
            <span id="statusAmount" class="status-value">$0.00</span>
        </div>
    </div>
</div>

<!-- Map Container -->
<div id="mapContainer">
    <button class="back-button" onclick="hideMap()">Ã—</button>
    <div id="map"></div>

    <div id="bottomPopup" class="bottom-popup">
        <div class="popup-header">
        </div>
        <div class="popup-content">
            <div class="popup-left">
                <div class="popup-title" id="popupTitle">Station Name</div>
            </div>
            <div class="popup-right">
                <div class="availability-info-new">
                    <div class="availability-item-new">
                        <div class="availability-icon-container">
                            <div class="availability-icon blue-dot"></div>
                            <div class="availability-number-new" id="availableSlots">5</div>
                        </div>
                        <div class="availability-label-new">To Take</div>
                    </div>
                    <div class="availability-item-new">
                        <div class="availability-icon-container">
                            <div class="availability-icon gray-dot"></div>
                            <div class="availability-number-new" id="occupiedSlots">8</div>
                        </div>
                        <div class="availability-label-new">To Return</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="directions-btn" onclick="openDirections()">Get Directions</button>
    </div>
</div>


<!-- Landing page content - shown when no battery ID -->
<div id="landing-container" style="display: none;">
    <div style="
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin: 0 auto;
        ">
        <!-- Battery ID Input -->
        <div style="
                background-color: #000000;
                border-radius: 20px;
                padding: 20px;
                margin-bottom: 16px;
            ">
            <div style="
                    font-size: 13px;
                    color: #FFFFFF;
                    margin: 40px 0 40px 0;
                    text-align: center;
                    line-height: 1.3;
                ">Insert the 4 digit number to see<br>duration and amount paid</div>
            <div class="battery-id-input-container" style="
                    display: flex;
                    justify-content: center;
                    gap: 8px;
                    margin-bottom: 15px;
                ">
                <input type="text" class="battery-id-digit" maxlength="1" data-index="0" style="
                        width: 45px;
                        height: 50px;
                        padding: 0;
                        font-size: 24px;
                        font-weight: bold;
                        text-align: center;
                        border: 1px solid #FFFFFF;
                        border-radius: 8px;
                        background-color: #000000;
                        color: #FFFFFF;
                        box-sizing: border-box;
                        text-transform: uppercase;
                    ">
                <input type="text" class="battery-id-digit" maxlength="1" data-index="1" style="
                        width: 45px;
                        height: 50px;
                        padding: 0;
                        font-size: 24px;
                        font-weight: bold;
                        text-align: center;
                        border: 1px solid #FFFFFF;
                        border-radius: 8px;
                        background-color: #000000;
                        color: #FFFFFF;
                        box-sizing: border-box;
                        text-transform: uppercase;
                    ">
                <input type="text" class="battery-id-digit" maxlength="1" data-index="2" style="
                        width: 45px;
                        height: 50px;
                        padding: 0;
                        font-size: 24px;
                        font-weight: bold;
                        text-align: center;
                        border: 1px solid #FFFFFF;
                        border-radius: 8px;
                        background-color: #000000;
                        color: #FFFFFF;
                        box-sizing: border-box;
                        text-transform: uppercase;
                    ">
                <input type="text" class="battery-id-digit" maxlength="1" data-index="3" style="
                        width: 45px;
                        height: 50px;
                        padding: 0;
                        font-size: 24px;
                        font-weight: bold;
                        text-align: center;
                        border: 1px solid #FFFFFF;
                        border-radius: 8px;
                        background-color: #000000;
                        color: #FFFFFF;
                        box-sizing: border-box;
                        text-transform: uppercase;
                    ">
            </div>
        </div>

        <!-- Website Link -->
        <a href="https://cuub.tech" target="_blank" style="
                background-color: #000000;
                border: 1px solid #35383C;
                border-radius: 20px;
                padding: 20px;
                margin: 8px 5px 0px;
                cursor: pointer;
                transition: background-color 0.3s ease;
                text-decoration: none;
                color: inherit;
                display: block;
            " onmouseover="this.style.backgroundColor='#1C1E20'" onmouseout="this.style.backgroundColor='#000000'">
            <div style="
                    font-size: 25px;
                    font-weight: bold;
                    margin: 0 0 10px 0;
                ">Visit Our Website</div>
            <div style="
                    font-size: 13px;
                    color: #CCCCCC;
                    margin: 0;
                    line-height: 1.3;
                ">Learn more about our services at cuub.tech</div>
        </a>




    </div>
</div>

<div id="output" style="display: none;">
    <div id="loadingMessage" style="
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            font-size: 13px;
            font-weight: normal;
            color: #B0D2FF;
            text-align: center;
            margin-top: -100px;
        ">
        <span id="loadingText"></span>
    </div>
    
    <div id="batteryContent" style="display: none;">
        <div id="elapsedTimeContainer">
            <p style="
                    margin: 0px;
                    font-size: 13px;
                    font-weight: bold;
                    color: #CCCCCC;
                ">
                Rent Duration
            </p>
            <p id="elapsedTime">--:--:--</p>
        </div>

        <div class="containers-wrapper">
            <div id="amountPaidContainer">
                <p style="
                        margin: 0px;
                        font-size: 20px;
                        font-family: Arial, sans-serif;
                        font-weight: bold;
                        font-style: normal;
                        color: #CCCCCC;
                        width: fit-content;
                    ">
                    Paid
                </p>
                <p id="amountPaid">$0.00</p>
            </div>
        </div>
    </div>
</div>

<div id="buttons-container" style="display: none;">

</div>

<!-- Global Customer Support Button - will be dynamically positioned -->
<div id="globalSupportBtn" style="display: none;">
    <button class="support-btn" onclick="contactSupport()">
        <div style="
                font-size: 25px;
                font-weight: bold;
            ">
            Customer Support
        </div>
        <div id="supportSubtext" style="font-size: 13px; color: #B0D2FF; margin-top: 10px;">
            Tap for questions, complaints, and refunds!
        </div>
    </button>
</div>

<!-- Global Map Button - will be dynamically positioned -->
<div id="globalMapBtn" style="display: none;">
    <button class="view-locations-btn" onclick="showMap()">
        <div style="
                font-size: 25px;
                font-weight: bold;
            ">
            Find locations to return
        </div>
        <div style="
                font-size: 13px;
                color: #9D9D9D;
                margin-top: 10px;
                opacity: 0;
                height: 15px;
            ">
            &nbsp;
        </div>
    </button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
<script>
    const { DateTime } = luxon;
    let borrowTime = null;
    let map = null;
    let currentStation = null;
    let selectedStationIndex = -1;
    let statusUpdateInterval = null;
    let currentBatteryId = null;
    let isFirstLoad = true;

    // DePaul University station locations - will be loaded from API
    let stationLocations = {};

    let stations = [];

    // Load location data from API
    async function loadLocationData() {
        try {
            const response = await fetch('/api/locations');
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const locationData = await response.json();
            
            // Convert array to object keyed by ID
            stationLocations = {};
            locationData.forEach(location => {
                stationLocations[location.id] = {
                    address: location.address,
                    coordinates: location.coordinates
                };
            });
            
            console.log('Loaded location data:', stationLocations);
        } catch (error) {
            console.error('Error loading location data:', error);
        }
    }

    async function fetchStationData() {
        try {
            const response = await fetch('/api/stations');
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const stationData = await response.json();

            // Merge with location data
            stations = stationData.map(station => ({
                id: station.id,
                name: station.name,
                address: station.address,
                coordinates: stationLocations[station.id]?.coordinates || [0, 0],
                available: station.available,
                occupied: station.occupied,
                error: station.error
            }));

            console.log('Updated stations data:', stations);

            // Update map if it exists
            if (map && map.getSource('stations')) {
                updateMapStations();
            }

            return stations;
        } catch (error) {
            console.error('Error fetching station data:', error);
            // Fall back to default data if API fails
            stations = [
                {
                    id: 'DTN00872',
                    name: 'DePaul LP Student Center',
                    address: 'LP Student Center, 1st Floor, Chicago, IL',
                    coordinates: [-87.65415, 41.92335],
                    available: 0,
                    occupied: 0,
                    error: true
                },
                {
                    id: 'DTN00971',
                    name: 'DePaul University Loop',
                    address: 'Loop Student Center, 11th Floor, Chicago, IL',
                    coordinates: [-87.6298, 41.8776],
                    available: 0,
                    occupied: 0,
                    error: true
                },
                {
                    id: 'DTN00970',
                    name: 'DePaul Theater School',
                    address: 'Theater School, 1st Floor, Chicago, IL',
                    coordinates: [-87.65875687443715, 41.92483761368347],
                    available: 0,
                    occupied: 0,
                    error: true
                },
                {
                    id: 'BJH09881',
                    name: 'DePaul University Parlay Lincoln Park',
                    address: 'Parlay Lincoln Park, Chicago, IL',
                    coordinates: [-87.65328, 41.92927],
                    available: 0,
                    occupied: 0,
                    error: true
                },
                {
                    id: 'BJH09883',
                    name: 'Kelly\'s Pub',
                    address: 'Kelly\'s Pub, Chicago, IL',
                    coordinates: [-87.65298, 41.92158],
                    available: 0,
                    occupied: 0,
                    error: true
                }
            ];
            return stations;
        }
    }

    function updateMapStations() {
        if (!map || !map.getSource('stations')) return;

        const stationFeatures = stations.map((station, index) => ({
            'type': 'Feature',
            'properties': {
                'name': station.name,
                'address': station.address,
                'available': station.available,
                'occupied': station.occupied,
                'index': index,
                'error': station.error
            },
            'geometry': {
                'type': 'Point',
                'coordinates': station.coordinates
            }
        }));

        map.getSource('stations').setData({
            'type': 'FeatureCollection',
            'features': stationFeatures
        });
    }

    function convertChinaToChicagoTime(chinaTimeStr) {
        return chinaTimeStr ? DateTime.fromISO(chinaTimeStr, { zone: "Asia/Shanghai" }).setZone("America/Chicago") : null;
    }

    function getTimeElapsed(startTime) {
        if (!startTime) return "Invalid Time";
        const diff = DateTime.now().setZone("America/Chicago").diff(startTime, ['hours', 'minutes', 'seconds']);
        const hours = String(diff.hours).padStart(2, '0');
        const minutes = String(diff.minutes).padStart(2, '0');
        const seconds = String(Math.floor(diff.seconds)).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    }

    function calculateAmountPaid(startTime) {
        if (!startTime) return "$0.00";
        const hoursElapsed = DateTime.now().diff(startTime, 'hours').hours;
        let amount = 0;

        if (hoursElapsed <= 168) {
            const days = Math.ceil(hoursElapsed / 24);
            amount = days * 3;
        } else {
            amount = 21;
        }

        return `$${amount.toFixed(2)}`;
    }

    function updateElapsedTime() {
        if (borrowTime) {
            const elapsedTimeElement = document.getElementById("elapsedTime");
            const amountPaidElement = document.getElementById("amountPaid");

            if (elapsedTimeElement) {
                elapsedTimeElement.textContent = getTimeElapsed(borrowTime);
            }
            if (amountPaidElement) {
                amountPaidElement.textContent = calculateAmountPaid(borrowTime);
            }

            // Update rental status window if visible
            if (document.getElementById('rentalStatus').style.display !== 'none') {
                const statusDurationElement = document.getElementById('statusDuration');
                const statusAmountElement = document.getElementById('statusAmount');

                if (statusDurationElement) {
                    statusDurationElement.textContent = getTimeElapsed(borrowTime);
                }
                if (statusAmountElement) {
                    statusAmountElement.textContent = calculateAmountPaid(borrowTime);
                }
            }
        }
    }

    function showRentalStatus() {
        // Only show rental status window when map isvisible
        if (borrowTime && document.getElementById('mapContainer').style.display === 'block') {
            document.getElementById('rentalStatus').style.display = 'block';
            const statusDurationElement = document.getElementById('statusDuration');
            const statusAmountElement = document.getElementById('statusAmount');

            if (statusDurationElement) {
                statusDurationElement.textContent = getTimeElapsed(borrowTime);
            }
            if (statusAmountElement) {
                statusAmountElement.textContent = calculateAmountPaid(borrowTime);
            }

            if (statusUpdateInterval) clearInterval(statusUpdateInterval);
            statusUpdateInterval = setInterval(updateElapsedTime, 1000);
        }
    }

    function updateBatteryData(data) {
        if (data.pGhtime) {
            // Battery returned - update the content
            const chiReturnTime = convertChinaToChicagoTime(data.pGhtime);
            const finalAmountPaid = data.finalAmountPaid || calculateAmountPaid(convertChinaToChicagoTime(data.pBorrowtime), chiReturnTime);
            
            // Update the elapsed time container
            const elapsedTimeContainer = document.getElementById('elapsedTimeContainer');
            if (elapsedTimeContainer) {
                elapsedTimeContainer.innerHTML = `
                    <p style="
                        margin: 0px;
                        font-size: 25px;
                        font-weight: bold;
                        color: #FFFFFF;
                    ">
                        Battery Returned
                    </p>
                `;
            }
            
            // Update the amount paid
            const amountPaidElement = document.getElementById('amountPaid');
            if (amountPaidElement) {
                amountPaidElement.textContent = finalAmountPaid;
            }
        } else {
            // Active rental - update the time and amount
            borrowTime = convertChinaToChicagoTime(data.pBorrowtime);
            if (borrowTime) {
                // Update elapsed time
                const elapsedTimeElement = document.getElementById('elapsedTime');
                if (elapsedTimeElement) {
                    elapsedTimeElement.textContent = getTimeElapsed(borrowTime);
                }
                
                // Update amount paid
                const amountPaidElement = document.getElementById('amountPaid');
                if (amountPaidElement) {
                    amountPaidElement.textContent = calculateAmountPaid(borrowTime);
                }
            }
        }
    }

    async function fetchBatteryData() {
        const path = window.location.pathname;
        let batteryId = '';

        if (path.startsWith('/demo/')) {
            batteryId = path.substring(6); // Remove '/demo/'
        } else if (path.startsWith('/demo')) {
            batteryId = ''; // Just /demo with no battery ID
        } else if (path !== '/' && path !== '') {
            batteryId = path.substring(1); // Remove leading '/' for direct battery ID
        }

        currentBatteryId = batteryId;
        const outputDiv = document.getElementById("output");
        const loadingMessage = document.getElementById("loadingMessage");
        const batteryContent = document.getElementById("batteryContent");

        // Show loading message only on first load
        if (isFirstLoad && loadingMessage && batteryContent) {
            loadingMessage.style.display = 'flex';
            batteryContent.style.display = 'none';
            // Hide global buttons during loading
            const globalSupportBtn = document.getElementById('globalSupportBtn');
            const globalMapBtn = document.getElementById('globalMapBtn');
            if (globalSupportBtn) globalSupportBtn.style.display = 'none';
            if (globalMapBtn) globalMapBtn.style.display = 'none';
            typeLoadingMessage();
        }

        if (!batteryId) {
            // Only show demo content if we're specifically on the /demo route
            if (path === '/demo') {
                const randomMinutes = Math.floor(Math.random() * 60) + 1;
                borrowTime = DateTime.now().minus({ minutes: randomMinutes });

                const newContainerHTML = `
                    <div id="newContainer" onclick="window.open('https://calendly.com/vlad-valchkou-cuub/intro-to-investors', '_blank');">
                        <div style="
                            font-size: 20px;
                            font-family: Arial, sans-serif;
                            font-weight: bold;
                            color: #FFFFFF;
                            margin: 0px;
                        ">
                            GET A REFUND!
                        </div>
                        <div style="
                            font-size: 13px;
                            font-family: Arial, sans-serif;
                            color: #FFFFFF;
                            margin-top: 10px;
                            line-height: 1.3;
                        ">
                            Schedule a one on one<br>
                            feedback session<br>
                            with the founder
                        </div>
                    </div>
                `;

                // Hide loading message and show battery content
                if (loadingMessage && batteryContent) {
                    loadingMessage.style.display = 'none';
                    batteryContent.style.display = 'block';
                }
                
                // Show global buttons after content is loaded
                showGlobalSupportButton();
                showGlobalMapButton();
                
                // Mark that first load is complete
                isFirstLoad = false;

                outputDiv.innerHTML = `
                    <div id="loadingMessage" style="
                            display: none;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                            height: 100dvh;
                            font-size: 13px;
                            font-weight: normal;
                            color: #B0D2FF;
                            text-align: center;
                            margin-top: -100px;
                        ">
                        <span id="loadingText"></span>
                    </div>
                    
                    <div id="batteryContent" style="display: block;">
                        <div id="elapsedTimeContainer">
                            <p style="
                                margin: 0px;
                                font-size: 13px;
                                font-weight: bold;
                                color: #CCCCCC;
                            ">
                                Rent Duration
                            </p>
                            <p id="elapsedTime">${getTimeElapsed(borrowTime)}</p>
                        </div>

                        <div class="containers-wrapper">
                            <div id="amountPaidContainer">
                                <p style="
                                    margin: 0px;
                                    font-size: 20px;
                                    font-family: Arial, sans-serif;
                                    font-weight: bold;
                                    font-style: normal;
                                    color: #CCCCCC;
                                    width: fit-content;
                                ">
                                    Paid
                                </p>
                                <p id="amountPaid" style="font-family: Arial, sans-serif; font-weight: bold; font-size: 50px;">$3.00</p>
                            </div>
                            ${newContainerHTML}
                        </div>
                    </div>
                `;
                showRentalStatus();
            } else {
                // For landing page (no battery ID and not /demo), just hide the loading message
                // and show global buttons without any battery content
                if (loadingMessage && batteryContent) {
                    loadingMessage.style.display = 'none';
                    batteryContent.style.display = 'none';
                }
                
                // Show global buttons
                showGlobalSupportButton();
                showGlobalMapButton();
                
                // Clear any content
                outputDiv.innerHTML = '';
                
                // Mark that first load is complete
                isFirstLoad = false;
            }
            return;
        }

        const host = window.location.hostname;
        const port = window.location.port ? `:${window.location.port}` : '';
        const protocol = window.location.protocol;
        const apiUrl = `${protocol}//${host}${port}/api/battery/${batteryId}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("Battery not found");

            const data = await response.json();
            
            // Hide loading message and show battery content
            if (loadingMessage && batteryContent) {
                loadingMessage.style.display = 'none';
                batteryContent.style.display = 'block';
            }
            
            // Show global buttons after content is loaded
            showGlobalSupportButton();
            showGlobalMapButton();
            
            // If not first load, just update the existing elements
            if (!isFirstLoad) {
                updateBatteryData(data);
                return;
            }
            
            // Mark that first load is complete
            isFirstLoad = false;

            outputDiv.innerHTML = "";

            if (data.pGhtime) {
                const chiReturnTime = convertChinaToChicagoTime(data.pGhtime);
                const finalAmountPaid = data.finalAmountPaid || calculateAmountPaid(convertChinaToChicagoTime(data.pBorrowtime), chiReturnTime);

                outputDiv.innerHTML = `
                    <div id="elapsedTimeContainer">
                        <p style="
                            margin: 0px;
                            font-size: 25px;
                            font-weight: bold;
                            color: #FFFFFF;
                        ">
                            Battery Returned
                        </p>
                    </div>

                    <div class="containers-wrapper">
                        <div id="amountPaidContainer">
                            <p style="
                                margin: 0px;
                                font-size: 20px;
                                font-family: Arial, sans-serif;
                                font-weight: bold;
                                font-style: normal;
                                color: #CCCCCC;
                                width: fit-content;
                            ">
                                Paid
                            </p>
                            <p id="amountPaid" style="font-family: Arial, sans-serif; font-weight: bold; font-size: 50px;">${finalAmountPaid}</p>
                        </div>
                        <div id="newContainer" onclick="window.open('https://calendly.com/vlad-valchkou-cuub/intro-to-investors', '_blank');">
                            <div style="
                                font-size: 20px;
                                font-family: Arial, sans-serif;
                                font-weight: bold;
                                color: #FFFFFF;
                                margin: 0px;
                            ">
                                GET A REFUND!
                            </div>
                            <div style="
                                font-size: 13px;
                                font-family: Arial, sans-serif;
                                color: #FFFFFF;
                                margin-top: 10px;
                                line-height: 1.3;
                            ">
                                Schedule a one on one<br>
                                feedback session<br>
                                with the founder
                            </div>
                        </div>
                    </div>
                `;
            } else {
                borrowTime = convertChinaToChicagoTime(data.pBorrowtime);
                if (borrowTime) {
                    outputDiv.innerHTML = `
                        <div id="elapsedTimeContainer">
                            <p style="
                                margin: 0px;
                                font-size: 13px;
                                font-weight: bold;
                                color: #CCCCCC;
                            ">
                                Rent Duration
                            </p>
                            <p id="elapsedTime">--:--:--</p>
                        </div>

                        <div class="containers-wrapper">
                            <div id="amountPaidContainer">
                                <p style="
                                    margin: 0px;
                                    font-size: 20px;
                                    font-family: Arial, sans-serif;
                                    font-weight: bold;
                                    font-style: normal;
                                    color: #CCCCCC;
                                    width: fit-content;
                                ">
                                    Paid
                                </p>
                                <p id="amountPaid">$0.00</p>
                            </div>
                            <div id="newContainer" onclick="window.open('https://calendly.com/vlad-valchkou-cuub/intro-to-investors', '_blank');">
                                <div style="
                                    font-size: 20px;
                                    font-family: Arial, sans-serif;
                                    font-weight: bold;
                                    color: #FFFFFF;
                                    margin: 0px;
                                ">
                                    GET A REFUND!
                                </div>
                                <div style="
                                    font-size: 13px;
                                    font-family: Arial, sans-serif;
                                    color: #FFFFFF;
                                    margin-top: 10px;
                                    line-height: 1.3;
                                ">
                                    Schedule a one on one<br>
                                    feedback session<br>
                                    with the founder
                                </div>
                            </div>
                        </div>
                    `;
                    showRentalStatus();
                } else {
                    outputDiv.innerHTML = `<p><strong>Invalid Borrow Time</strong></p>`;
                }
            }
        } catch (error) {
            outputDiv.innerHTML = `<p>Error: ${error.message}</p>`;
            console.error("Error:", error.message);
        }
    }

    function showMap() {
        document.getElementById('mapContainer').style.display = 'block';

        if (!map) {
            initializeMap();
        }

        // Show rental status window when map is opened
        showRentalStatus();
    }

    function hideMap() {
        document.getElementById('mapContainer').style.display = 'none';
        closeBottomPopup();

        // Hide rental status window when map is closed
        document.getElementById('rentalStatus').style.display = 'none';
        if (statusUpdateInterval) {
            clearInterval(statusUpdateInterval);
            statusUpdateInterval = null;
        }
    }

    function initializeMap() {
        mapboxgl.accessToken = 'pk.eyJ1IjoidmxhZHZhbGNoa291IiwiYSI6ImNtYzlhemFpZTF2MXUya29sNzM4OXhuZjYifQ.jrfH07QPTw_XfnmXXv42Pw';

        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-87.64, 41.90],
            zoom: 12            });

        map.on('load', async () => {
            // Load location data first
            await loadLocationData();
            
            // Fetch initial station data
            await fetchStationData();

            map.addSource('stations', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': stations.map((station, index) => ({
                        'type': 'Feature',
                        'properties': {
                            'name': station.name,
                            'address': station.address,
                            'available': station.available,
                            'occupied': station.occupied,
                            'index': index,
                            'error': station.error
                        },
                        'geometry': {
                            'type': 'Point',
                            'coordinates': station.coordinates
                        }
                    }))
                },
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });

            map.addLayer({
                'id': 'clusters',
                'type': 'circle',
                'source': 'stations',
                'filter': ['has', 'point_count'],
                'paint': {
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        15,
                        3, 20,
                        5, 25
                    ],
                    'circle-color': '#009FFF'
                }
            });

            map.addLayer({
                'id': 'cluster-count',
                'type': 'symbol',
                'source': 'stations',
                'filter': ['has', 'point_count'],
                'layout': {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 14
                },
                'paint': {
                    'text-color': '#ffffff'
                }
            });

            map.addLayer({
                'id': 'stations-layer',
                'type': 'circle',
                'source': 'stations',
                'filter': ['!', ['has', 'point_count']],
                'paint': {
                    'circle-radius': 12,
                    'circle-color': '#009FFF'
                }
            });

            map.addLayer({
                'id': 'stations-selected',
                'type': 'circle',
                'source': 'stations',
                'filter': ['!', ['has', 'point_count']],
                'paint': {
                    'circle-radius': 20,
                    'circle-color': '#009FFF',
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#FFFFFF',
                    'circle-opacity': 0,
                    'circle-stroke-opacity': 0
                }
            });

            map.addLayer({
                'id': 'stations-hover',
                'type': 'circle',
                'source': 'stations',
                'paint': {
                    'circle-radius': 18,
                    'circle-color': '#009FFF',
                    'circle-opacity': 0
                },
                'filter': ['==', 'index', -1]
            });

            map.on('click', 'clusters', (e) => {
                try {
                    const features = map.queryRenderedFeatures(e.point, {
                        layers: ['clusters']
                    });

                    if (features && features.length > 0 && features[0] && features[0].properties) {
                        const clusterId = features[0].properties.cluster_id;
                        const geometry = features[0].geometry;
                        const coordinates = geometry ? geometry.coordinates : null;

                        if (coordinates && Array.isArray(coordinates) && coordinates.length >= 2) {
                            map.getSource('stations').getClusterExpansionZoom(
                                clusterId,
                                (err, zoom) => {
                                    if (!err) {
                                        map.easeTo({
                                            center: coordinates,
                                            zoom: zoom
                                        });
                                    }
                                }
                            );
                        }
                    }
                } catch (error) {
                    console.error('Error handling cluster click:', error);
                }
            });

            map.on('click', 'stations-layer', (e) => {
                try {
                    const features = map.queryRenderedFeatures(e.point, {
                        layers: ['stations-layer']
                    });

                    if (features && features.length > 0 && features[0]) {
                        const feature = features[0];
                        const properties = feature.properties || {};
                        const geometry = feature.geometry || {};
                        const coordinates = geometry.coordinates;

                        if (!coordinates || !Array.isArray(coordinates) || coordinates.length < 2) {
                            console.error('Invalid coordinates:', coordinates);
                            return;
                        }

                        const lng = parseFloat(coordinates[0]);
                        const lat = parseFloat(coordinates[1]);
                        if (isNaN(lng) || isNaN(lat)) {
                            console.error('Invalid coordinate values:', coordinates);
                            return;
                        }

                        const station = {
                            name: properties.name || 'Unknown Station',
                            address: properties.address || 'Unknown Address',
                            available: properties.available || 0,
                            occupied: properties.occupied || 0,
                            coordinates: [lng, lat]
                        };

                        selectedStationIndex = properties.index !== undefined ? properties.index : -1;

                        map.setFilter('stations-selected', ['==', 'index', selectedStationIndex]);
                        map.setPaintProperty('stations-selected', 'circle-opacity', 1.0);
                        map.setPaintProperty('stations-selected', 'circle-stroke-opacity', 1);

                        showBottomPopup(station);
                    }
                } catch (error) {
                    console.error('Error handling station click:', error);
                }
            });

            map.on('mouseenter', 'stations-layer', (e) => {
                try {
                    if (e.features && e.features.length > 0 && e.features[0]) {
                        const feature = e.features[0];
                        const properties = feature.properties || {};

                        map.getCanvas().style.cursor = 'pointer';
                        const index = properties.index || 0;

                        map.setFilter('stations-hover', ['all', ['!', ['has', 'point_count']], ['==', 'index', index]]);
                        map.setPaintProperty('stations-hover', 'circle-opacity', 1);
                    }
                } catch (error) {
                    console.error('Error handling station hover:', error);
                }
            });

            map.on('mouseleave', 'stations-layer', (e) => {
                map.getCanvas().style.cursor = '';
                map.setPaintProperty('stations-hover', 'circle-opacity', 0);
            });

            map.on('mouseenter', 'clusters', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'clusters', () => {
                map.getCanvas().style.cursor = '';
            });

            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(
                new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true,
                    showUserHeading: true
                })
            );

            // Close popup when clicking on empty map areas
            map.on('click', (e) => {
                // Check if the click was on a station or cluster
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['stations-layer', 'clusters']
                });

                // If no features were clicked, close the popup
                if (!features || features.length === 0) {
                    closeBottomPopup();
                }
            });
        });
    }

    function showBottomPopup(station) {
        currentStation = station;
        document.getElementById('popupTitle').textContent = station.name;
        document.getElementById('availableSlots').textContent = station.occupied;
        document.getElementById('occupiedSlots').textContent = station.available;
        document.getElementById('bottomPopup').classList.add('show');
    }

    function closeBottomPopup() {
        document.getElementById('bottomPopup').classList.remove('show');
        currentStation = null;

        selectedStationIndex = -1;
        if (map) {
            map.setFilter('stations-selected', ['==', 'index', -1]);
            map.setPaintProperty('stations-selected', 'circle-opacity', 0);
            map.setPaintProperty('stations-selected', 'circle-stroke-opacity', 0);
        }
    }

    function openDirections() {
        if (!currentStation) return;

        const lat = currentStation.coordinates[1];
        const lng = currentStation.coordinates[0];

        const userAgent = navigator.userAgent || navigator.vendor || window.opera;

        if (/iPad|iPhone|iPod/.test(userAgent)) {
            window.open(`maps://maps.apple.com/?daddr=${lat},${lng}&dirflg=d`);
        } else if (/android/i.test(userAgent)) {
            window.open(`geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(currentStation.name)})`);
        } else {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
        }
    }

    function showGlobalSupportButton() {
        const globalSupportBtn = document.getElementById('globalSupportBtn');
        if (globalSupportBtn) {
            globalSupportBtn.style.display = 'block';
            startTypingAnimation();
        }
    }

    function showGlobalMapButton() {
        const globalMapBtn = document.getElementById('globalMapBtn');
        if (globalMapBtn) {
            globalMapBtn.style.display = 'block';
        }
    }

    function typeLoadingMessage() {
        const loadingText = document.getElementById('loadingText');
        const fullText = "Never Run Out of Power";
        let index = 0;

        const typeInterval = setInterval(() => {
            if (index < fullText.length) {
                loadingText.textContent = fullText.substring(0, index + 1);
                index++;
            } else {
                clearInterval(typeInterval);
            }
        }, 50); // Adjust speed as needed (50ms per character)
    }

    function startTypingAnimation() {
        // Try to find the supportSubtext element with a retry mechanism
        let attempts = 0;
        const maxAttempts = 10;
        
        const tryStartAnimation = () => {
            const subtextElement = document.getElementById('supportSubtext');
            if (!subtextElement) {
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(tryStartAnimation, 100);
                }
                return;
            }
            
            const typingElement = subtextElement.querySelector('.typewriter-text');
            if (!typingElement) {
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(tryStartAnimation, 100);
                }
                return;
            }
            
            const fullText = "Tap for questions, complaints, and refunds!";

            // Start typing animation after a small delay
            setTimeout(() => {
                let index = 0;
                typingElement.textContent = '';

                const typeInterval = setInterval(() => {
                    if (index < fullText.length) {
                        typingElement.textContent = fullText.substring(0, index + 1);
                        index++;
                    } else {
                        clearInterval(typeInterval);
                        // Remove cursor after typing is complete
                        typingElement.classList.remove('typing-animation');
                    }
                }, 75); // Adjust speed as needed (75ms per character)
            }, 500); // Delay before starting typing
        };
        
        tryStartAnimation();
    }

    window.onload = async () => {
        const path = window.location.pathname;
        let batteryId = '';

        if (path.startsWith('/demo/')) {
            batteryId = path.substring(6); // Remove '/demo/'
        } else if (path.startsWith('/demo')) {
            batteryId = ''; // Just /demo with no battery ID
        } else if (path !== '/' && path !== '') {
            batteryId = path.substring(1); // Remove leading '/' for direct battery ID
        }

        currentBatteryId = batteryId;

        // If no battery ID and not on /demo, show landing page
        if (!batteryId && path !== '/demo') {
            document.getElementById('landing-container').style.display = 'block';
            // Show global buttons for landing page
            showGlobalSupportButton();
            showGlobalMapButton();
            // Set up battery ID digit inputs
            setupBatteryIdInputs();
            return;
        }

        // For battery ID pages or /demo, show battery content directly (skip phone verification)
        document.getElementById('output').style.display = 'block';
        document.getElementById('buttons-container').style.display = 'block';
        
        setInterval(updateElapsedTime, 1000);
        setInterval(fetchBatteryData, 10000);

        // Load location data first, then fetch station data
        await loadLocationData();
        await fetchStationData();

        // Update station data every 30 seconds
        setInterval(fetchStationData, 30000);

        // Set up battery ID digit inputs
        setupBatteryIdInputs();

        // Fetch battery data immediately
        fetchBatteryData();
    };

    function contactSupport() {
        let message;
        if (currentBatteryId) {
            message = encodeURIComponent(`The number on my battery is: ${currentBatteryId}`);
        } else {
            message = encodeURIComponent(`Hello, I need help with battery rental service.`);
        }
        window.location.href = `sms:7739460236?body=${message}`;
    }











    function setupBatteryIdInputs() {
        const batteryIdDigits = document.querySelectorAll('.battery-id-digit');

        batteryIdDigits.forEach((input, index) => {
            input.addEventListener('input', function(e) {
                // Convert to uppercase and only allow alphanumeric characters
                e.target.value = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();

                if (e.target.value) {
                    e.target.style.borderColor = '#009FFF';
                    // Move to next input
                    if (index < batteryIdDigits.length - 1) {
                        batteryIdDigits[index + 1].focus();
                    }

                    // Check if all inputs are filled
                    checkBatteryIdComplete();
                } else {
                    e.target.style.borderColor = '#262626';
                }
            });

            input.addEventListener('keydown', function(e) {
                // Handle backspace
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    batteryIdDigits[index - 1].focus();
                    batteryIdDigits[index - 1].value = '';
                    batteryIdDigits[index - 1].style.borderColor = '#262626';
                }

                // Handle arrow keys
                if (e.key === 'ArrowLeft' && index > 0) {
                    batteryIdDigits[index - 1].focus();
                }
                if (e.key === 'ArrowRight' && index < batteryIdDigits.length - 1) {
                    batteryIdDigits[index + 1].focus();
                }

                // Handle Enter key
                if (e.key === 'Enter') {
                    goToBatteryId();
                }
            });

            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/[^A-Za-z0-9]/g, '').toUpperCase().substring(0, 4);

                for (let i = 0; i < pastedData.length && i < batteryIdDigits.length; i++) {
                    batteryIdDigits[i].value = pastedData[i];
                    batteryIdDigits[i].style.borderColor = '#009FFF';
                }

                if (pastedData.length >= 4) {
                    checkBatteryIdComplete();
                }
            });
        });
    }

    function checkBatteryIdComplete() {
        const batteryIdDigits = document.querySelectorAll('.battery-id-digit');
        let batteryId = '';

        batteryIdDigits.forEach(input => {
            batteryId += input.value;
        });

        if (batteryId.length === 4) {
            // Auto-submit when all 4 digits are entered
            setTimeout(() => {
                goToBatteryId();
            }, 300);
        }
    }

    function goToBatteryId() {
        const batteryIdDigits = document.querySelectorAll('.battery-id-digit');
        let batteryId = '';

        batteryIdDigits.forEach(input => {
            batteryId += input.value;
        });
        
        if (batteryId.length === 0) {
            alert('Please enter a battery ID');
            return;
        }
        
        if (batteryId.length < 4) {
            alert('Please enter a complete 4-digit battery ID');
            return;
        }
        
        // Navigate to the battery ID page
        window.location.href = `/${batteryId}`;
    }
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
</body>
</html>